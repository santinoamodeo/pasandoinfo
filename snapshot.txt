import os, time, pickle
from dotenv import load_dotenv
from PIL import Image
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.common.exceptions import NoSuchElementException, TimeoutException
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

# --- Env ---
load_dotenv(os.path.join(os.path.dirname(__file__), "..", ".env"))
USER = os.getenv("GROWATT_USER")
PASS = os.getenv("GROWATT_PASS")
DASHBOARD_URL = os.getenv("DASHBOARD_URL", "https://server.growatt.com/newPortal/#/index")
SEL = os.getenv("DASHBOARD_SELECTOR", "").strip()
OUT = os.getenv("OUTPUT_PATH", "/var/www/growatt/latest.png")
VW = int(os.getenv("VIEWPORT_W", "1920"))
VH = int(os.getenv("VIEWPORT_H", "1080"))

COOKIES_PATH = os.path.join(os.path.dirname(__file__), "cookies.pkl")

def build_driver():
    opts = Options()
    opts.add_argument("--headless")
    opts.add_argument("--no-sandbox")
    opts.add_argument("--disable-dev-shm-usage")
    opts.add_argument(f"--window-size={VW},{VH}")
    # Rutas típicas en Ubuntu 18.04; ChromeDriver lo encuentra solo si está en PATH
    return webdriver.Chrome(options=opts)

def load_cookies(driver, url):
    if os.path.exists(COOKIES_PATH):
        driver.get("https://server.growatt.com/")
        with open(COOKIES_PATH, "rb") as f:
            cookies = pickle.load(f)
        for c in cookies:
            # evita errores por dominios
            c.pop('sameSite', None)
            try:
                driver.add_cookie(c)
            except Exception:
                pass
        driver.get(url)

def save_cookies(driver):
    with open(COOKIES_PATH, "wb") as f:
        pickle.dump(driver.get_cookies(), f)

def is_login_page(driver):
    u = driver.current_url.lower()
    if "login" in u: 
        return True
    # Heurística: si aparece input de usuario
    try:
        driver.find_element(By.CSS_SELECTOR, 'input[name="account"], input[name="username"]')
        return True
    except NoSuchElementException:
        return False

def do_login(driver):
    driver.get("https://server.growatt.com/")
    wait = WebDriverWait(driver, 20)
    user = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, 'input[name="account"], input[name="username"]')))
    # contraseña (intenta varios)
    try:
        pwd = driver.find_element(By.CSS_SELECTOR, 'input[name="password"]')
    except NoSuchElementException:
        pwd = driver.find_element(By.CSS_SELECTOR, 'input[type="password"]')
    user.clear(); user.send_keys(USER)
    pwd.clear();  pwd.send_keys(PASS)

    # Botón: intenta variantes comunes
    for sel in ['button[type="submit"]','.login-btn','.el-button--primary','.btn-login']:
        try:
            driver.find_element(By.CSS_SELECTOR, sel).click()
            break
        except NoSuchElementException:
            continue

    # A veces no navega; ve directo al dashboard
    try:
        driver.get(DASHBOARD_URL)
    except Exception:
        pass

    # Guarda cookies para próximas corridas
    time.sleep(2)
    save_cookies(driver)

def fullpage_screenshot(driver, out_path):
    # Para full page, scrollea y arma un PNG único
    total_height = driver.execute_script("return document.body.scrollHeight")
    # Si el dashboard es SPA y cabe en viewport, basta con un screenshot normal
    if total_height <= VH:
        driver.save_screenshot(out_path)
        return
    # Scrollea en tramos y pega
    stitched = Image.new('RGB', (VW, total_height), (255,255,255))
    y = 0
    for offset in range(0, total_height, VH):
        driver.execute_script(f"window.scrollTo(0, {offset});")
        time.sleep(0.3)
        tmp = out_path + ".part.png"
        driver.save_screenshot(tmp)
        img = Image.open(tmp)
        crop_h = min(VH, total_height - offset)
        stitched.paste(img.crop((0, VH - crop_h, VW, VH)), (0, y))
        y += crop_h
        img.close()
        os.remove(tmp)
    stitched.save(out_path)

def element_screenshot(driver, selector, out_path):
    WebDriverWait(driver, 15).until(EC.presence_of_element_located((By.CSS_SELECTOR, selector)))
    el = driver.find_element(By.CSS_SELECTOR, selector)
    el.screenshot(out_path)

def main():
    driver = build_driver()
    try:
        driver.get(DASHBOARD_URL)
        load_cookies(driver, DASHBOARD_URL)
        time.sleep(2)
        if is_login_page(driver):
            do_login(driver)

        # Espera a que carguen números/gráficos
        time.sleep(3)

        if SEL:
            element_screenshot(driver, SEL, OUT)
        else:
            fullpage_screenshot(driver, OUT)

        print(f"[OK] Guardado {OUT}")
    except Exception as e:
        print("[ERR]", e)
    finally:
        driver.quit()

if __name__ == "__main__":
    main()
